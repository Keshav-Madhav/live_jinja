<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Jinja Parser (Python/Pyodide)</title>

    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material-darker.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/jinja2/jinja2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>

    <style>
        :root {
            --editor-background: #212121;
            --pane-background: #fdfdfd;
            --border-color: #e0e0e0;
            --header-color: #424242;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: #f4f4f9;
            color: #333;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        h1 {
            text-align: center;
            color: var(--header-color);
            margin: 10px 0 5px;
            font-weight: 500;
            font-size: 18px;
        }
        .container {
            display: flex;
            flex-grow: 1;
            gap: 10px;
            padding: 0 10px 10px;
            min-width: 0; /* Allow flex shrinking */
            overflow: hidden;
        }
        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: calc(100vh - 90px); /* Adjusted for smaller header */
            min-width: 0; /* Allow flex shrinking */
            overflow: hidden;
        }
        .right-panel {
            flex: 1;
            height: calc(100vh - 90px); /* Adjusted for smaller header */
            min-width: 0; /* Allow flex shrinking */
            overflow: hidden;
        }
        .pane {
            display: flex;
            flex-direction: column;
            background: var(--pane-background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            min-height: 0; /* Allow flex items to shrink */
            min-width: 0; /* Allow flex items to shrink horizontally */
            width: 100%;
        }
        .template-pane {
            flex: 2;
            min-height: 0;
        }
        .variables-pane {
            flex: 1;
            min-height: 0;
        }
        .pane h2 {
            margin: 0;
            padding: 12px;
            font-size: 14px;
            background: var(--pane-background);
            border-bottom: 1px solid var(--border-color);
            color: var(--header-color);
            font-weight: 600;
        }
        .pane-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--pane-background);
            border-bottom: 1px solid var(--border-color);
            padding: 12px;
        }
        .pane-header h2 {
            margin: 0;
            padding: 0;
            border-bottom: none;
            background: none;
        }
        .header-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2196F3;
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        .rerender-btn {
            padding: 6px 12px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.3s;
        }
        .rerender-btn:hover {
            background: #1976D2;
        }
        .rerender-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .control-label {
            font-size: 12px;
            color: var(--header-color);
            font-weight: 500;
        }
        .header-btn {
            padding: 4px 8px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: background 0.3s;
        }
        .header-btn:hover {
            background: #1976D2;
        }
        .CodeMirror {
            flex-grow: 1;
            height: auto;
            font-size: 12px;
            min-height: 0;
            width: 100%;
            max-width: 100%;
        }
        .CodeMirror-scroll {
            overflow-x: auto !important;
            overflow-y: auto !important;
            max-width: 100%;
        }
        .CodeMirror-lines {
            max-width: 100%;
        }
        #output-pane {
            height: 100%;
            min-height: 0;
        }
        #output {
            flex-grow: 1;
            padding: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow: auto;
            font-family: "Menlo", "Consolas", monospace;
            font-size: 12px;
            line-height: 1.6;
            height: 100%;
            min-height: 0;
            position: relative;
        }
        .error {
            color: #d32f2f;
            font-weight: bold;
        }
        .variable-input {
            margin-bottom: 15px;
        }
        .variable-input label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--header-color);
            font-size: 12px;
        }
        .variable-input input, .variable-input textarea {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 12px;
            font-family: "Menlo", "Consolas", monospace;
            background: white;
            box-sizing: border-box;
        }
        .variable-input textarea {
            min-height: 60px;
            resize: vertical;
        }
        .variable-input input:focus, .variable-input textarea:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }
        .form-mode-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-bottom: 1px solid var(--border-color);
            font-size: 12px;
        }
        .mode-switch {
            background: #2196F3;
            color: white;
            cursor: pointer;
            text-decoration: none;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
            border: none;
            font-weight: 500;
            transition: background 0.3s;
        }
        .mode-switch:hover {
            background: #1976D2;
        }
        
        /* Resize handles */
        .resize-handle {
            background: transparent;
            transition: background 0.2s;
        }
        .resize-handle:hover {
            background: rgba(33, 150, 243, 0.5);
        }
        .resize-handle-horizontal {
            height: 4px;
            cursor: row-resize;
            width: 100%;
        }
        .resize-handle-vertical {
            width: 4px;
            cursor: col-resize;
            height: 100%;
        }
        
        /* Container adjustments for resizing */
        .resizable-container {
            display: flex;
            flex-grow: 1;
            gap: 0;
            padding: 0 10px 10px;
            min-width: 0;
            overflow: hidden;
        }
        .resizable-left-panel {
            display: flex;
            flex-direction: column;
            gap: 0;
            min-width: 200px;
            max-width: calc(100vw - 250px);
            overflow: hidden;
        }
        .resizable-right-panel {
            min-width: 200px;
            overflow: hidden;
        }
        .resizable-template-pane {
            min-height: 100px;
            overflow: hidden;
        }
        .resizable-variables-pane {
            min-height: 100px;
            overflow: hidden;
        }
        
        /* Loading state */
        #loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2em;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 999;
            display: none;
        }
        
        /* --- UPDATED WHITESPACE STYLING --- */
        .whitespace-char {
            /* Use relative positioning to anchor the pseudo-element */
            position: relative;
        }
        .whitespace-char::before {
            /* Position the symbol absolutely so it doesn't affect layout */
            position: absolute;
            color: #757575;
            opacity: 0.6;
            /* Prevent the symbols from being selected with the text */
            pointer-events: none;
        }
        .whitespace-char.space::before {
            content: '·';
        }
        .whitespace-char.tab::before {
            content: '→';
        }
        .whitespace-char.newline::before {
            content: '↵';
        }

    </style>
</head>
<body>

    <div class="loading-overlay" id="loading-overlay"></div>
    <div id="loader">Loading Python Environment...</div>

    <h1>Live Jinja Parser (Pyodide) 🐍</h1>
    
    <div class="resizable-container" id="main-container">
        <div class="resizable-left-panel" id="left-panel">
            <div class="pane resizable-template-pane" id="template-pane">
                <div class="pane-header">
                    <h2>Jinja Template</h2>
                    <div class="header-controls">
                        <button class="header-btn" id="copy-template-btn">Copy Template</button>
                        <div class="control-group">
                            <span class="control-label">Text Wrap</span>
                            <label class="switch">
                                <input type="checkbox" id="text-wrap-toggle" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <textarea id="jinja-template"></textarea>
            </div>
            <div class="resize-handle resize-handle-horizontal" id="horizontal-resize"></div>
            <div class="pane resizable-variables-pane" id="variables-pane">
                <div class="pane-header">
                    <h2 id="variables-header">Variables (JSON)</h2>
                    <div class="header-controls">
                        <button class="header-btn" id="extract-variables-header">Extract Variables</button>
                        <button class="mode-switch" id="toggle-mode">Switch to Form Mode</button>
                    </div>
                </div>
                <textarea id="variables"></textarea>
                <div id="variables-form" style="display: none; padding: 15px; overflow-y: auto; flex-grow: 1;"></div>
            </div>
        </div>
        <div class="resize-handle resize-handle-vertical" id="vertical-resize"></div>
        <div class="resizable-right-panel" id="right-panel">
            <div class="pane" id="output-pane">
                <div class="pane-header">
                <h2>Output</h2>
                    <div class="header-controls">
                        <button class="header-btn" id="copy-output-btn">Copy Output</button>
                        <div class="control-group">
                            <span class="control-label">Whitespace</span>
                            <label class="switch">
                                <input type="checkbox" id="show-whitespace-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="control-group">
                            <span class="control-label">Auto Rerender</span>
                            <label class="switch">
                                <input type="checkbox" id="auto-rerender-toggle" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <button class="rerender-btn" id="manual-rerender" disabled>Rerender</button>
                    </div>
                </div>
                <pre id="output"></pre>
            </div>
        </div>
    </div>

<script>
    // Start with minimal template and variables
    const defaultTemplate = `Hello {{ name }}!`;

    const defaultVars = {
        name: "World"
    };
    
    // --- EDITOR SETUP ---
    const commonEditorOptions = {
        lineNumbers: true,
        theme: 'material-darker',
        lineWrapping: true,
        viewportMargin: Infinity, // Render all content
        scrollbarStyle: 'native'
    };

    const jinjaEditor = CodeMirror.fromTextArea(document.getElementById('jinja-template'), {
        ...commonEditorOptions,
        mode: 'jinja2',
    });

    const varsEditor = CodeMirror.fromTextArea(document.getElementById('variables'), {
        ...commonEditorOptions,
        mode: { name: 'javascript', json: true },
    });

    jinjaEditor.setValue(defaultTemplate);
    varsEditor.setValue(JSON.stringify(defaultVars, null, 2));
    
    const outputElement = document.getElementById('output');
    const loader = document.getElementById('loader');
    const loadingOverlay = document.getElementById('loading-overlay');

    // Pyodide setup
    let pyodide = null;
    let isInitialized = false;

    // --- CONTROL ELEMENTS ---
    const textWrapToggle = document.getElementById('text-wrap-toggle');
    const autoRerenderToggle = document.getElementById('auto-rerender-toggle');
    const manualRerenderBtn = document.getElementById('manual-rerender');
    const extractVariablesBtn = document.getElementById('extract-variables-header');
    const toggleModeBtn = document.getElementById('toggle-mode');
    const variablesForm = document.getElementById('variables-form');
    const variablesHeader = document.getElementById('variables-header');
    const copyTemplateBtn = document.getElementById('copy-template-btn');
    const copyOutputBtn = document.getElementById('copy-output-btn');
    const showWhitespaceToggle = document.getElementById('show-whitespace-toggle');
    
    // --- STATE MANAGEMENT ---
    let isFormMode = false;
    let extractedVariables = new Set();
    let currentVariableValues = {};
    
    // --- RESIZE STATE ---
    let isResizing = false;
    let resizeType = null;
    let startX = 0;
    let startY = 0;
    let startWidth = 0;
    let startHeight = 0;

    // --- PYODIDE SETUP ---
    
    async function setupPyodide() {
        try {
            loader.style.display = 'block';
            loadingOverlay.style.display = 'block';
            
            pyodide = await loadPyodide();
            await pyodide.loadPackage("jinja2");
            
            isInitialized = true;
            loader.style.display = 'none';
            loadingOverlay.style.display = 'none';
            
            // Initial render after setup
            update();
        } catch (error) {
            loader.textContent = `Failed to load Python environment: ${error.message}`;
            loader.style.color = '#d32f2f';
        }
    }

    // --- CORE LOGIC ---

    /**
     * Provides visual feedback for button clicks
     */
    function showButtonFeedback(button, message = 'Done!', duration = 1500) {
        const originalText = button.textContent;
        const originalBackground = button.style.background || getComputedStyle(button).backgroundColor;
        
        button.textContent = message;
        button.style.background = '#4CAF50';
        button.disabled = true;
        
        setTimeout(() => {
            button.textContent = originalText;
            button.style.background = originalBackground;
            button.disabled = false;
        }, duration);
    }

    /**
     * Provides visual feedback for toggle switches
     */
    function showToggleFeedback(toggleElement, message) {
        // Create a temporary tooltip-like element
        const feedback = document.createElement('div');
        feedback.textContent = message;
        feedback.style.cssText = `
            position: absolute;
            background: #4CAF50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            z-index: 1000;
            pointer-events: none;
            transform: translateX(-50%);
            white-space: nowrap;
        `;
        
        // Position relative to the toggle
        const rect = toggleElement.getBoundingClientRect();
        feedback.style.left = `${rect.left + rect.width / 2}px`;
        feedback.style.top = `${rect.top - 30}px`;
        
        document.body.appendChild(feedback);
        
        setTimeout(() => {
            if (feedback.parentNode) {
                feedback.parentNode.removeChild(feedback);
            }
        }, 1000);
    }

    /**
     * UPDATED: Renders text with visible whitespace characters without affecting layout.
     */
    function renderWhitespace(text) {
        // First, escape any potential HTML in the text to prevent XSS
        const escapedText = text.replace(/&/g, '&amp;')
                                .replace(/</g, '&lt;')
                                .replace(/>/g, '&gt;')
                                .replace(/"/g, '&quot;')
                                .replace(/'/g, '&#039;');

        // Wrap whitespace characters in spans. The original characters are
        // preserved for layout, and CSS pseudo-elements add the visual symbols.
        return escapedText
            .replace(/ /g, '<span class="whitespace-char space"> </span>')
            .replace(/\t/g, '<span class="whitespace-char tab">\t</span>')
            .replace(/\n/g, '<span class="whitespace-char newline"></span>\n');
    }

    /**
     * Extracts variable names and structures from a Jinja template
     */
    function extractVariablesFromTemplate(template) {
        const variableStructures = {};
        
        // Helper function to set nested property
        function setNestedProperty(obj, path, value) {
            const keys = path.split('.');
            let current = obj;
            
            for (let i = 0; i < keys.length - 1; i++) {
                const key = keys[i];
                if (!(key in current)) {
                    // Determine if next key is numeric (array index) or not
                    const nextKey = keys[i + 1];
                    current[key] = /^\d+$/.test(nextKey) ? [] : {};
                }
                current = current[key];
            }
            
            const lastKey = keys[keys.length - 1];
            if (Array.isArray(current) && /^\d+$/.test(lastKey)) {
                const index = parseInt(lastKey);
                while (current.length <= index) {
                    current.push('');
                }
                current[index] = value;
            } else {
                current[lastKey] = value;
            }
        }
        
        // 1. Match {{ variable.property }} and {{ variable.property.nested }} patterns
        const variablePattern = /\{\{\s*([a-zA-Z_][a-zA-Z0-9_]*(?:\.[a-zA-Z_][a-zA-Z0-9_]*)*)(?:\s*\|\s*[^}]+)?\s*\}\}/g;
        let match;
        
        while ((match = variablePattern.exec(template)) !== null) {
            const fullPath = match[1];
            const rootVar = fullPath.split('.')[0];
            
            if (fullPath.includes('.')) {
                // This is an object property access
                if (!(rootVar in variableStructures)) {
                    variableStructures[rootVar] = {};
                }
                setNestedProperty(variableStructures, fullPath, '');
            } else {
                // Simple variable
                if (!(rootVar in variableStructures)) {
                    variableStructures[rootVar] = '';
                }
            }
        }
        
        // 2. Match {% for item in variable %} patterns - indicates variable is a list/array
        const forPattern = /\{\%\s*for\s+\w+\s+in\s+([a-zA-Z_][a-zA-Z0-9_]*)\s*\%\}/g;
        while ((match = forPattern.exec(template)) !== null) {
            const varName = match[1];
            if (!(varName in variableStructures)) {
                variableStructures[varName] = ['']; // Single empty string for lists
            } else if (!Array.isArray(variableStructures[varName]) && typeof variableStructures[varName] !== 'object') {
                // Convert to array if it was a simple string
                variableStructures[varName] = [''];
            }
        }
        
        // 3. Match {% for key, value in variable.items() %} patterns - indicates variable is a dict
        const dictForPattern = /\{\%\s*for\s+\w+,\s*\w+\s+in\s+([a-zA-Z_][a-zA-Z0-9_]*)\s*\.\s*items\s*\(\s*\)\s*\%\}/g;
        while ((match = dictForPattern.exec(template)) !== null) {
            const varName = match[1];
            if (!(varName in variableStructures)) {
                variableStructures[varName] = { key1: 'value1', key2: 'value2' };
            }
        }
        
        // 4. Match {% if variable %} and {% if variable.property %} patterns
        const ifPattern = /\{\%\s*if\s+([a-zA-Z_][a-zA-Z0-9_]*(?:\.[a-zA-Z_][a-zA-Z0-9_]*)*)/g;
        while ((match = ifPattern.exec(template)) !== null) {
            const fullPath = match[1];
            const rootVar = fullPath.split('.')[0];
            
            if (fullPath.includes('.')) {
                if (!(rootVar in variableStructures)) {
                    variableStructures[rootVar] = {};
                }
                setNestedProperty(variableStructures, fullPath, true); // Boolean for if conditions
            } else {
                if (!(rootVar in variableStructures)) {
                    variableStructures[rootVar] = true; // Default boolean for if conditions
                }
            }
        }
        
        // 5. Match array access patterns like {{ variable[0] }} or {{ variable.items[0] }}
        const arrayAccessPattern = /\{\{\s*([a-zA-Z_][a-zA-Z0-9_]*(?:\.[a-zA-Z_][a-zA-Z0-9_]*)*)\s*\[\s*(\d+)\s*\](?:\s*\|\s*[^}]+)?\s*\}\}/g;
        while ((match = arrayAccessPattern.exec(template)) !== null) {
            const basePath = match[1];
            const index = parseInt(match[2]);
            const rootVar = basePath.split('.')[0];
            
            if (!(rootVar in variableStructures)) {
                variableStructures[rootVar] = basePath.includes('.') ? {} : [];
            }
            
            // Create array structure
            const arrayPath = basePath + '.' + index;
            setNestedProperty(variableStructures, arrayPath, '');
        }
        
        // 6. Look for loop variables that access properties: {% for item in items %}{{ item.name }}{% endfor %}
        const loopWithPropertyPattern = /\{\%\s*for\s+(\w+)\s+in\s+([a-zA-Z_][a-zA-Z0-9_]*)\s*\%\}(.*?)\{\%\s*endfor\s*\%\}/gs;
        while ((match = loopWithPropertyPattern.exec(template)) !== null) {
            const loopVar = match[1];
            const arrayVar = match[2];
            const loopContent = match[3];
            
            // Find properties accessed on the loop variable
            const loopVarPattern = new RegExp(`\\{\\{\\s*${loopVar}\\.([a-zA-Z_][a-zA-Z0-9_]*)`, 'g');
            let propMatch;
            const itemStructure = {};
            
            while ((propMatch = loopVarPattern.exec(loopContent)) !== null) {
                itemStructure[propMatch[1]] = '';
            }
            
            if (Object.keys(itemStructure).length > 0) {
                // Create array of objects
                variableStructures[arrayVar] = [itemStructure, itemStructure];
            }
        }
        
        return variableStructures;
    }

    /**
     * Creates form inputs for extracted variables
     */
    function createVariableForm(variableStructures) {
        variablesForm.innerHTML = '';
        
        if (Object.keys(variableStructures).length === 0) {
            variablesForm.innerHTML = '<p style="color: #666; font-style: italic;">No variables found in template. Use {{ variable_name }} syntax.</p>';
            return;
        }
        
        // Helper function to create form inputs recursively
        function createInputsForStructure(structure, baseName = '', level = 0) {
            const container = document.createElement('div');
            container.style.marginLeft = `${level * 15}px`;
            
            if (Array.isArray(structure)) {
                // Handle arrays
                const label = document.createElement('label');
                label.textContent = `${baseName} (Array)`;
                label.style.fontWeight = 'bold';
                label.style.color = '#2196F3';
                label.style.display = 'block';
                label.style.marginBottom = '5px';
                container.appendChild(label);
                
                const textarea = document.createElement('textarea');
                textarea.id = `var-${baseName}`;
                textarea.name = baseName;
                textarea.value = JSON.stringify(structure, null, 2);
                textarea.placeholder = `JSON array for ${baseName}`;
                textarea.style.width = '100%';
                textarea.style.minHeight = '80px';
                textarea.style.padding = '6px 8px';
                textarea.style.border = '1px solid #e0e0e0';
                textarea.style.borderRadius = '4px';
                textarea.style.fontSize = '12px';
                textarea.style.fontFamily = '"Menlo", "Consolas", monospace';
                textarea.style.marginBottom = '15px';
                textarea.style.resize = 'vertical';
                
                textarea.addEventListener('input', function() {
                    try {
                        const parsed = JSON.parse(this.value);
                        currentVariableValues[baseName] = parsed;
                        this.style.borderColor = '#e0e0e0';
                    } catch (e) {
                        this.style.borderColor = '#d32f2f';
                        currentVariableValues[baseName] = this.value;
                    }
                    if (autoRerenderToggle.checked) {
                        debounce(update, 300)();
                    }
                });
                
                container.appendChild(textarea);
                
            } else if (typeof structure === 'object' && structure !== null) {
                // Handle objects
                if (baseName) {
                    const label = document.createElement('label');
                    label.textContent = `${baseName} (Object)`;
                    label.style.fontWeight = 'bold';
                    label.style.color = '#4CAF50';
                    label.style.display = 'block';
                    label.style.marginBottom = '5px';
                    container.appendChild(label);
                }
                
                // Check if it's a simple object (all values are primitives)
                const isSimpleObject = Object.values(structure).every(val => 
                    typeof val === 'string' || typeof val === 'number' || typeof val === 'boolean'
                );
                
                if (isSimpleObject && Object.keys(structure).length <= 5) {
                    // Create individual inputs for simple objects
                    Object.entries(structure).forEach(([key, value]) => {
            const inputDiv = document.createElement('div');
            inputDiv.className = 'variable-input';
                        inputDiv.style.marginLeft = `${(level + 1) * 15}px`;
            
            const label = document.createElement('label');
                        label.textContent = `${baseName ? baseName + '.' : ''}${key}`;
                        label.style.fontSize = '11px';
                        label.style.color = '#666';
                        
                        const input = document.createElement('input');
                        input.type = typeof value === 'boolean' ? 'checkbox' : 'text';
                        input.id = `var-${baseName ? baseName + '.' : ''}${key}`;
                        input.name = `${baseName ? baseName + '.' : ''}${key}`;
                        
                        if (typeof value === 'boolean') {
                            input.checked = value;
                            input.addEventListener('change', function() {
                                const path = this.name.split('.');
                                let current = currentVariableValues;
                                for (let i = 0; i < path.length - 1; i++) {
                                    if (!(path[i] in current)) current[path[i]] = {};
                                    current = current[path[i]];
                                }
                                current[path[path.length - 1]] = this.checked;
                                if (autoRerenderToggle.checked) {
                                    debounce(update, 300)();
                                }
                            });
                        } else {
                            input.value = value;
                            input.addEventListener('input', function() {
                                const path = this.name.split('.');
                                let current = currentVariableValues;
                                for (let i = 0; i < path.length - 1; i++) {
                                    if (!(path[i] in current)) current[path[i]] = {};
                                    current = current[path[i]];
                                }
                                current[path[path.length - 1]] = this.value;
                                if (autoRerenderToggle.checked) {
                                    debounce(update, 300)();
                                }
                            });
                        }
                        
                        inputDiv.appendChild(label);
                        inputDiv.appendChild(input);
                        container.appendChild(inputDiv);
                    });
            } else {
                    // Complex object - use JSON textarea
                    const textarea = document.createElement('textarea');
                    textarea.id = `var-${baseName}`;
                    textarea.name = baseName;
                    textarea.value = JSON.stringify(structure, null, 2);
                    textarea.placeholder = `JSON object for ${baseName}`;
                    textarea.style.width = '100%';
                    textarea.style.minHeight = '100px';
                    textarea.style.padding = '6px 8px';
                    textarea.style.border = '1px solid #e0e0e0';
                    textarea.style.borderRadius = '4px';
                    textarea.style.fontSize = '12px';
                    textarea.style.fontFamily = '"Menlo", "Consolas", monospace';
                    textarea.style.marginBottom = '15px';
                    textarea.style.resize = 'vertical';
                    
                    textarea.addEventListener('input', function() {
                        try {
                            const parsed = JSON.parse(this.value);
                            currentVariableValues[baseName] = parsed;
                            this.style.borderColor = '#e0e0e0';
                        } catch (e) {
                            this.style.borderColor = '#d32f2f';
                            currentVariableValues[baseName] = this.value;
                        }
                        if (autoRerenderToggle.checked) {
                            debounce(update, 300)();
                        }
                    });
                    
                    container.appendChild(textarea);
                }
                
            } else {
                // Handle primitive values
                const inputDiv = document.createElement('div');
                inputDiv.className = 'variable-input';
                
                const label = document.createElement('label');
                label.textContent = baseName;
                label.setAttribute('for', `var-${baseName}`);
                
                const input = document.createElement(typeof structure === 'boolean' ? 'input' : 
                    (typeof structure === 'string' && structure.length > 50) ? 'textarea' : 'input');
                
                input.id = `var-${baseName}`;
                input.name = baseName;
                
                if (typeof structure === 'boolean') {
                    input.type = 'checkbox';
                    input.checked = structure;
                    input.addEventListener('change', function() {
                        currentVariableValues[baseName] = this.checked;
                        if (autoRerenderToggle.checked) {
                            debounce(update, 300)();
                        }
                    });
                } else {
                    if (input.tagName === 'TEXTAREA') {
                        input.value = structure;
                        input.style.minHeight = '60px';
                        input.style.resize = 'vertical';
                    } else {
                        input.type = 'text';
                        input.value = structure;
                        input.placeholder = `Enter value for ${baseName}`;
                    }
                    
            input.addEventListener('input', function() {
                        currentVariableValues[baseName] = this.value;
                if (autoRerenderToggle.checked) {
                            debounce(update, 300)();
                }
            });
                }
            
            inputDiv.appendChild(label);
            inputDiv.appendChild(input);
                container.appendChild(inputDiv);
            }
            
            return container;
        }
        
        // Create inputs for each top-level variable
        Object.entries(variableStructures).forEach(([varName, structure]) => {
            const container = createInputsForStructure(structure, varName);
            variablesForm.appendChild(container);
        });
    }

    /**
     * Gets current variable values from form or JSON
     */
    function getCurrentVariables() {
        if (isFormMode) {
            const formData = {};
            variablesForm.querySelectorAll('input, textarea').forEach(input => {
                const varName = input.name;
                let value = input.value;
                
                // Try to parse as JSON if it looks like JSON
                if (value.trim().startsWith('{') || value.trim().startsWith('[') || 
                    value === 'true' || value === 'false' || 
                    (value.trim() && !isNaN(value.trim()))) {
                    try {
                        value = JSON.parse(value);
                    } catch (e) {
                        // Keep as string if not valid JSON
                    }
                }
                
                formData[varName] = value;
            });
            return formData;
        } else {
            try {
                return JSON.parse(varsEditor.getValue() || '{}');
            } catch (e) {
                return {};
            }
        }
    }


    /**
     * The main function to update the rendering. It gets triggered on any change.
     */
    async function update() {
        if (!pyodide || !isInitialized) {
            outputElement.textContent = 'Python environment is still loading...';
            outputElement.className = '';
            return;
        }

        const template = jinjaEditor.getValue();
        let context;

        // 1. Get variables from current mode (form or JSON)
        try {
            context = getCurrentVariables();
        } catch (e) {
            // If there's an error getting variables, show it
            outputElement.textContent = `Error in variables:\n${e.message}`;
            outputElement.className = 'error';
            return;
        }

        // 2. Render the template with the context using Python Jinja2
        try {
            const contextJson = JSON.stringify(context);
            
            // Escape template and context strings for Python
            const escapedTemplate = template.replace(/\\/g, '\\\\').replace(/"/g, '\\"').replace(/\n/g, '\\n');
            const escapedContext = contextJson.replace(/\\/g, '\\\\').replace(/"/g, '\\"');
            
            const result = pyodide.runPython(`
import jinja2
import json

try:
    template_str = """${escapedTemplate}"""
    context_str = """${escapedContext}"""
    
    template = jinja2.Template(template_str)
    context = json.loads(context_str)
    result = template.render(context)
except jinja2.exceptions.TemplateError as e:
    result = f"Jinja2 Template Error: {e}"
except json.JSONDecodeError as e:
    result = f"JSON Error: {e}"
except Exception as e:
    result = f"Error: {e}"

result
            `);
            
            // Set the main content, checking for whitespace toggle
            if (showWhitespaceToggle.checked) {
                outputElement.innerHTML = renderWhitespace(result);
            } else {
                outputElement.textContent = result;
            }
            outputElement.className = result.includes('Error:') ? 'error' : '';
        } catch (e) {
            outputElement.textContent = `Python execution error: ${e.message}`;
            outputElement.className = 'error';
        }
    }

    // --- CONTROL HANDLERS ---

    // Extract variables button
    extractVariablesBtn.addEventListener('click', function() {
        const template = jinjaEditor.getValue();
        const newVariableStructures = extractVariablesFromTemplate(template);
        
        // Get current values from the active mode (form or JSON)
        const currentValues = getCurrentVariables();
        
        // Merge existing values with new structure, preserving user data where possible
        function mergeStructures(newStruct, existingValues) {
            if (Array.isArray(newStruct)) {
                return existingValues && Array.isArray(existingValues) ? existingValues : newStruct;
            } else if (typeof newStruct === 'object' && newStruct !== null) {
                const merged = {};
                Object.keys(newStruct).forEach(key => {
                    if (existingValues && typeof existingValues === 'object' && key in existingValues) {
                        merged[key] = mergeStructures(newStruct[key], existingValues[key]);
                    } else {
                        merged[key] = newStruct[key];
                    }
                });
                return merged;
            } else {
                return existingValues !== undefined ? existingValues : newStruct;
            }
        }
        
        const mergedVariables = {};
        Object.keys(newVariableStructures).forEach(varName => {
            mergedVariables[varName] = mergeStructures(
                newVariableStructures[varName], 
                currentValues[varName]
            );
        });
        
        // Update state
        extractedVariables = new Set(Object.keys(newVariableStructures));
        currentVariableValues = mergedVariables;
        
        // If in form mode, recreate the form
        if (isFormMode) {
            createVariableForm(newVariableStructures);
        }
        
        // Update JSON editor to reflect current values
        varsEditor.setValue(JSON.stringify(mergedVariables, null, 2));
        
        // Re-render
        update();

        // Show feedback
        const variableCount = Object.keys(newVariableStructures).length;
        const message = variableCount > 0 ? `Found ${variableCount} variable${variableCount !== 1 ? 's' : ''}!` : 'No variables found!';
        showButtonFeedback(this, message, 2000);
    });

    // Mode toggle button
    toggleModeBtn.addEventListener('click', function() {
        const wasFormMode = isFormMode;
        isFormMode = !isFormMode;
        
        if (isFormMode) {
            // Switch to form mode
            varsEditor.getWrapperElement().style.display = 'none';
            variablesForm.style.display = 'block';
            toggleModeBtn.textContent = 'Switch to JSON Mode';
            variablesHeader.textContent = 'Variables (Form)';
            
            // Get current variables from JSON and update our state
            try {
                const currentVars = JSON.parse(varsEditor.getValue() || '{}');
                currentVariableValues = currentVars;
                
                // Convert to the structure format expected by createVariableForm
                const variableStructures = {};
                Object.keys(currentVars).forEach(key => {
                    variableStructures[key] = currentVars[key];
                });
                
                extractedVariables = new Set(Object.keys(currentVars));
            
            // Create form with current variables
                createVariableForm(variableStructures);
            } catch (e) {
                // If JSON is invalid, keep existing state or create empty form
                createVariableForm({});
            }
        } else {
            // Switch to JSON mode
            varsEditor.getWrapperElement().style.display = 'block';
            variablesForm.style.display = 'none';
            toggleModeBtn.textContent = 'Switch to Form Mode';
            variablesHeader.textContent = 'Variables (JSON)';
            
            // Update JSON editor with current form values
            const currentVars = getCurrentVariables();
            varsEditor.setValue(JSON.stringify(currentVars, null, 2));
        }

        // Show feedback
        const mode = isFormMode ? 'Form' : 'JSON';
        showButtonFeedback(this, `Switched to ${mode}!`, 1500);
    });

    // Text wrap toggle
    textWrapToggle.addEventListener('change', function() {
        const wrapMode = this.checked;
        jinjaEditor.setOption('lineWrapping', wrapMode);
        varsEditor.setOption('lineWrapping', wrapMode);
        
        // Show feedback
        const message = wrapMode ? 'Text wrap enabled!' : 'Text wrap disabled!';
        showToggleFeedback(this.parentElement, message);
    });

    // Whitespace toggle
    showWhitespaceToggle.addEventListener('change', function() {
        update(); // Re-render the output with the new setting
        const message = this.checked ? 'Whitespace visible' : 'Whitespace hidden';
        showToggleFeedback(this.parentElement, message);
    });

    // Auto rerender toggle
    autoRerenderToggle.addEventListener('change', function() {
        manualRerenderBtn.disabled = this.checked;
        setupEventListeners();
        
        // Show feedback
        const message = this.checked ? 'Auto rerender enabled!' : 'Auto rerender disabled!';
        showToggleFeedback(this.parentElement, message);
    });

    // Manual rerender button
    manualRerenderBtn.addEventListener('click', function() {
        update();
        showButtonFeedback(this, 'Rerendered!', 1000);
    });

    // Copy template button
    copyTemplateBtn.addEventListener('click', async function() {
        try {
            const templateContent = jinjaEditor.getValue();
            await navigator.clipboard.writeText(templateContent);
            
            // Visual feedback
            const originalText = this.textContent;
            this.textContent = 'Copied!';
            this.style.background = '#4CAF50';
            
            setTimeout(() => {
                this.textContent = originalText;
                this.style.background = '#2196F3';
            }, 1500);
        } catch (err) {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = jinjaEditor.getValue();
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            // Visual feedback
            const originalText = this.textContent;
            this.textContent = 'Copied!';
            this.style.background = '#4CAF50';
            
            setTimeout(() => {
                this.textContent = originalText;
                this.style.background = '#2196F3';
            }, 1500);
        }
    });

    // Copy output button
    copyOutputBtn.addEventListener('click', async function() {
        try {
            const outputContent = outputElement.textContent;
            await navigator.clipboard.writeText(outputContent);
            
            // Visual feedback
            const originalText = this.textContent;
            this.textContent = 'Copied!';
            this.style.background = '#4CAF50';
            
            setTimeout(() => {
                this.textContent = originalText;
                this.style.background = '#2196F3';
            }, 1500);
        } catch (err) {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = outputElement.textContent;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            // Visual feedback
            const originalText = this.textContent;
            this.textContent = 'Copied!';
            this.style.background = '#4CAF50';
            
            setTimeout(() => {
                this.textContent = originalText;
                this.style.background = '#2196F3';
            }, 1500);
        }
    });

    // --- EVENT LISTENERS ---
    // Conditional event listeners based on auto-rerender setting
    function setupEventListeners() {
        if (autoRerenderToggle.checked) {
            jinjaEditor.on('change', debounce(update, 300));
            varsEditor.on('change', debounce(update, 300));
        } else {
            jinjaEditor.off('change', debounce(update, 300));
            varsEditor.off('change', debounce(update, 300));
        }
    }
    
    // Debounce function to prevent too frequent updates
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // --- RESIZE FUNCTIONALITY ---
    
    // Get resize elements
    const horizontalResize = document.getElementById('horizontal-resize');
    const verticalResize = document.getElementById('vertical-resize');
    const leftPanel = document.getElementById('left-panel');
    const rightPanel = document.getElementById('right-panel');
    const templatePane = document.getElementById('template-pane');
    const variablesPane = document.getElementById('variables-pane');
    const mainContainer = document.getElementById('main-container');
    
    // Initialize default sizes
    let leftPanelWidth = 50; // percentage
    let templatePaneHeight = 60; // percentage
    
    function setInitialSizes() {
        const containerRect = mainContainer.getBoundingClientRect();
        leftPanel.style.width = `${leftPanelWidth}%`;
        rightPanel.style.width = `${100 - leftPanelWidth}%`;
        
        const leftPanelRect = leftPanel.getBoundingClientRect();
        templatePane.style.height = `${templatePaneHeight}%`;
        variablesPane.style.height = `${100 - templatePaneHeight}%`;
    }
    
    // Horizontal resize (between template and variables)
    horizontalResize.addEventListener('mousedown', function(e) {
        isResizing = true;
        resizeType = 'horizontal';
        startY = e.clientY;
        
        const leftPanelRect = leftPanel.getBoundingClientRect();
        const templateRect = templatePane.getBoundingClientRect();
        startHeight = templateRect.height;
        
        document.addEventListener('mousemove', handleResize);
        document.addEventListener('mouseup', stopResize);
        e.preventDefault();
    });
    
    // Vertical resize (between left and right panels)
    verticalResize.addEventListener('mousedown', function(e) {
        isResizing = true;
        resizeType = 'vertical';
        startX = e.clientX;
        
        const containerRect = mainContainer.getBoundingClientRect();
        const leftRect = leftPanel.getBoundingClientRect();
        startWidth = leftRect.width;
        
        document.addEventListener('mousemove', handleResize);
        document.addEventListener('mouseup', stopResize);
        e.preventDefault();
    });
    
    function handleResize(e) {
        if (!isResizing) return;
        
        if (resizeType === 'horizontal') {
            const deltaY = e.clientY - startY;
            const leftPanelRect = leftPanel.getBoundingClientRect();
            const newTemplateHeight = startHeight + deltaY;
            const minHeight = 100;
            const maxHeight = leftPanelRect.height - minHeight - 4; // 4px for resize handle
            
            if (newTemplateHeight >= minHeight && newTemplateHeight <= maxHeight) {
                const templatePercentage = (newTemplateHeight / leftPanelRect.height) * 100;
                const variablesPercentage = 100 - templatePercentage;
                
                templatePane.style.height = `${templatePercentage}%`;
                variablesPane.style.height = `${variablesPercentage}%`;
                templatePaneHeight = templatePercentage;
            }
        } else if (resizeType === 'vertical') {
            const deltaX = e.clientX - startX;
            const containerRect = mainContainer.getBoundingClientRect();
            const newLeftWidth = startWidth + deltaX;
            const minWidth = 200;
            const maxWidth = containerRect.width - minWidth - 4; // 4px for resize handle
            
            if (newLeftWidth >= minWidth && newLeftWidth <= maxWidth) {
                const leftPercentage = (newLeftWidth / containerRect.width) * 100;
                const rightPercentage = 100 - leftPercentage;
                
                leftPanel.style.width = `${leftPercentage}%`;
                rightPanel.style.width = `${rightPercentage}%`;
                leftPanelWidth = leftPercentage;
            }
        }
        
        // Refresh CodeMirror editors after resize
        setTimeout(() => {
            jinjaEditor.refresh();
            varsEditor.refresh();
        }, 10);
    }
    
    function stopResize() {
        isResizing = false;
        resizeType = null;
        document.removeEventListener('mousemove', handleResize);
        document.removeEventListener('mouseup', stopResize);
    }
    
    // Handle window resize
    window.addEventListener('resize', function() {
        setTimeout(() => {
            jinjaEditor.refresh();
            varsEditor.refresh();
        }, 100);
    });

    // Initial setup
    setInitialSizes();
    setupEventListeners();

    // Start Pyodide and initial render
    setupPyodide();

</script>

</body>
</html>
